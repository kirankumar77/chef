#!/bin/bash
set -x
. /root/.bash_profile
. /root/.bashrc
export PM2_HOME="/root/.pm2"
export PATH=/usr/local/bin:/bin:/sbin:/usr/bin:/usr/sbin

cd /AZVOL
FOLDER=` ls | egrep '[a-z-]+api$' `
cd ${FOLDER}
pwd
mailsend()
        {
        local SUBJECT="$1 service is down `hostname`"
        local DATA="$1 service is down in the server `hostname` , Restarting service manually"
        echo "$DATA" | mail -s "$SUBJECT" praveen.sam@pearson.com -r praveensams16@gmail.com
        }

while [[ -f /var/run/service_lock ]]

do
	j=`ps aux | perl -ane 'if((/node.*server/)&&($_ !~ /perl\s+\-ane/)) {$y+=1}END{print $y}'`
	n=`ps aux | grep -i nginx | grep -v grep | wc -l`
	new=`ps aux | grep -i newrelic | grep -v grep | wc -l`

        if [[ ! -f /var/run/nginx.pid ]] || [[  $n -le 1 ]]
        then

                service nginx restart
                mailsend "nginx"

        fi

        if [[ $j -le 1 ]]
        then
                pm2 start server.js
                mailsend "node"
        fi

	if [[ ${new} -eq 0 ]]
	then
		service newrelic-sysmond restart 
		mailsend "newrelic"
	fi

        sleep 2

        echo `date`  >> /tmp/logs

done

