#!/bin/bash

# Add your backup dir location, password, mysql location and mysqldump location

DATE=`date +%d-%m-%Y-%H-%M-%S`
BACKUP_DIR="/AZVOL/data/backup"

MONGO=/usr/bin/mongo
MONGODUMP=/usr/bin/mongodump

SUBJECT="MonGo backup failed"
EMAIL=global.ops@globalenglish.com

# To create a new directory into backup directory location
#mkdir -p $BACKUP_DIR/$DATE

# dump the database
mongodump --host 10.168.204.166 --port 48078 -u Backup_User -p GRYHEY4t3rjo --authenticationDatabase admin --out $BACKUP_DIR/NEUSAPIProdMonGodbdump-$DATE


tar -zcf $BACKUP_DIR/NEUSAPIProdMonGodbdump-$DATE.tar $BACKUP_DIR/NEUSAPIProdMonGodbdump-$DATE

rm -rf $BACKUP_DIR/NEUSAPIProdMonGodbdump-$DATE

if [ -f $BACKUP_DIR/NEUSAPIProdMonGodbdump-$DATE.tar ];
    then
        echo "Mongo database backed up successfully"
        echo  "Mongo backup succeeded in Prod SAPI ROW db server" | mailx -r dhivya.munusamy@pearson.com -s "MonGo backup success" dhivya.munusamy@pearson.com
    else
        echo "Error: Could not take database backup!"
        echo -e "Mongo backup failed in Prod SAPI ROW db serverr" | mailx -r global.ops@globalenglish.com -s "MonGo backup failed" $EMAIL
fi


# Delete files older than 3 days
find $BACKUP_DIR/NEUSAPIProdMonGodbdump* -mtime +3 -exec rm {} \;

BKPFILE=NEUSAPIProdMonGodbdump-$DATE.tar

if [ -f $BACKUP_DIR/NEUSAPIProdMonGodbdump-$DATE.tar ];
then
	AZURE=`which azure`
	AZURE_ACCOUNT="nsemongodbbackups"
	AZURE_ACCOUNT_KEY="TVqe6SzLyJojdDCVMG4rerMzBRuWK3rfvS/i1FmJySD0mcDfJPsbe0n/hC3sfNneZU8M1ob85QlGbjg7SSfobg=="
	AZURE_CONTAINER="neusapiprodmongodbbackups"
	AZURE_BLOB=$BKPFILE
	UPLOAD_FILE=$BACKUP_DIR/$AZURE_BLOB
	/usr/local/bin/azure storage blob upload -a "$AZURE_ACCOUNT" -k "$AZURE_ACCOUNT_KEY" --container "$AZURE_CONTAINER" -f "$UPLOAD_FILE" -b "$AZURE_BLOB"
fi
